---
output: word_document
---

#Caricamento package

```{r packages, message=FALSE}
require(ggplot2)
require(dplyr)
require(GGally)
```

#Set up cartelle e creazione dataset

```{r directory e dataset}
getwd()
setwd("/Users/Americo/Documents/Education/Unitelma/tesi/data_analysis/dataset")
bank0 <- tbl_df(read.csv(file = "bank_full.csv", sep = ";"))
bank0_sm <- tbl_df(read.csv(file = "bank.csv", sep = ";"))
```

#Informazioni sul dataset

##Input variables

###bank client data
 
* 1 - age (numeric)
*    2 - job : type of job (categorical: "admin.","unknown","unemployed","management","housemaid","entrepreneur","student", "blue-collar","self-employed","retired","technician","services") 
*    3 - marital : marital status (categorical: "married","divorced","single"; note: "divorced" means divorced or widowed)
*    4 - education (categorical: "unknown","secondary","primary","tertiary")
*    5 - default: has credit in default? (binary: "yes","no")
*    6 - balance: average yearly balance, in euros (numeric) 
*    7 - housing: has housing loan? (binary: "yes","no")
*    8 - loan: has personal loan? (binary: "yes","no")
*    # related with the last contact of the current campaign:
*    9 - contact: contact communication type (categorical: "unknown","telephone","cellular") 
*   10 - day: last contact day of the month (numeric)
*   11 - month: last contact month of year (categorical: "jan", "feb", "mar", ..., "nov", "dec")
*   12 - duration: last contact duration, in seconds (numeric)

###Other attributes:

*   13 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
*   14 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric, -1 means client was not previously contacted)
*   15 - previous: number of contacts performed before this campaign and for this client (numeric)
*   16 - poutcome: outcome of the previous marketing campaign (categorical: "unknown","other","failure","success")

##Output variable (desired target)

*   17 - y - has the client subscribed a term deposit? (binary: "yes","no")

It should be stressed that due to internal competition and current financial crisis, there are huge pressures for European banks to increase a financial asset. To solve this issue, one adopted strategy is offer attractive long-term deposit applications with good interest rates, in particular by using directed marketing campaigns. Also, the same drivers are pressing for a reduction in costs and time. Thus, there is a need for an improvement in efficiency: lesser contacts should be done, but an approximately number of successes (clients subscribing the deposit) should be kept.

##Missing Attribute Values
None

#Esplorazione del dataset

##Esplorazione dimensioni

```{r exp dataset}
str(bank0)
dim(bank0)
```

Non ci sono variabili numeriche, solo interi e fattori. Da capire se servirà qualche trasformazione

#Esplorazione tabellare distribuzioni univariate

```{r 5 quantities}
summary(bank0)
```

##Age

```{r age graph}
g_age <- ggplot(bank0, aes(x = factor(age))) + geom_bar(col = "white")
g_age
g_age_y <- ggplot(bank0, aes(x = factor(age), fill = y)) + 
        geom_bar(col = "white", position = "fill") + 
        geom_hline(yintercept = mean(bank0$y!="yes"), width = 2, col = "black", linetype = 2)
g_age_y
```

Vediamo che dai 30 ai 59 anni l'incidenza di sottoscrizioni è pari a quella complessiva; c'è anche da dire che dopo i 60 non ci sono numerosità grandi:

```{r age table}
t_age_y <- bank0 %>%
        group_by (factor(age)) %>%
        summarise (n = n(), perc_y = mean(y=="yes"))
t_age_y
```

Una idea potrebbe essere quella di fare un binning 18-30, 31-59, 60 o più. Certo che la variabile sembra predittiva.

##Job

```{r job graph}
g_job  <- ggplot(bank0, aes(x = job)) +
        geom_bar()
g_job
g_job_y  <- ggplot(bank0, aes(x = job, fill = y)) +
        geom_bar(position = "fill") +
        geom_hline(yintercept = mean(bank0$y!="yes"), width = 2, col = "black", linetype = 2)
g_job_y
```

Non molto predittivo, c'è l'età che fa da counfounding e spiega la stessa variabilità di studenti e pensionati.

```{r job table}
t_job_y <- bank0 %>%
        group_by (job) %>%
        summarise (n = n(), perc_y = mean(y=="yes"))
t_job_y
```

Non mi spiego perché i disoccupati tendano a fare più depositi. Forse in questa categoria ci sono giovani a cui il deposito viene regalato dai genitori.

##Marital

```{r marital graph}
g_marital  <- ggplot(bank0, aes(x = marital)) +
        geom_bar()
g_marital
g_marital_y  <- ggplot(bank0, aes(x = marital, fill = y)) +
        geom_bar(position = "fill") +
        geom_hline(yintercept = mean(bank0$y!="yes"), width = 2, col = "black", linetype = 2)
g_marital_y
```

Non me lo aspettavo. Pochissima predittività della variabile

```{r marital table}
t_marital_y <- bank0 %>%
        group_by (marital) %>%
        summarise (n = n(), perc_y = mean(y=="yes"))
t_marital_y
```

I single tendono a farne un po' di più. Anche qui, confounding dell'età giovanile?

##Education

```{r education graph}
g_education  <- ggplot(bank0, aes(x = education)) +
        geom_bar()
g_education
g_education_y  <- ggplot(bank0, aes(x = education, fill = y)) +
        geom_bar(position = "fill") +
        geom_hline(yintercept = mean(bank0$y!="yes"), width = 2, col = "black", linetype = 2)
g_education_y
```

Sembra che a maggior livello culturale segua maggiore propensione a sottoscrivere depositi. Da capire se qui gli studenti fanno confounding, anche se ci credo meno. Penso (sarà da verificare) che anche tra i trentacinquenni ci siano molti laureati.


```{r education table}
t_education_y <- bank0 %>%
        group_by (education) %>%
        summarise (n = n(), perc_y = mean(y=="yes"))
t_education_y
```


##Default

```{r default graph}
g_default  <- ggplot(bank0, aes(x = default)) +
        geom_bar()
g_default
g_default_y  <- ggplot(bank0, aes(x = default, fill = y)) +
        geom_bar(position = "fill") +
        geom_hline(yintercept = mean(bank0$y!="yes"), width = 2, col = "black", linetype = 2)
g_default_y
```

Pochissimi in default, i no si comportanto come il campione, ma d'altronde sono pressoché tutto il campione. Certo il sì è un po' predittivo, ma poca numerosità.


```{r default table}
t_default_y <- bank0 %>%
        group_by (default) %>%
        summarise (n = n(), perc_y = mean(y=="yes"))
t_default_y
```

##Balance

```{r balance graph}
g_balance <- ggplot(bank0, aes(x = 1, y = balance)) + 
        geom_boxplot()
g_balance

g_balance_y <- ggplot(bank0, aes(x = y, y = balance)) + 
        geom_boxplot()
g_balance_y
```

è una distribuzione con un range molto ampio ma un range interquartile molto ristretto, sia complessivamente che per i due gruppi. Provo a capire se posso analizzare i dati fino al 95 percentile

```{r balance table}
quantile(bank0$balance, c(seq(0.1, 1, 0.05)))
perc_95 <- quantile(bank0$balance, 0.95)
```

```{r balance graph p95}
bank0_p95 <- bank0 %>%
        filter(balance <= perc_95)
g_balance_p95 <- ggplot(bank0_p95, aes(x = 1, y = balance)) + 
        geom_boxplot()
g_balance_p95

g_balance_y_p95 <- ggplot(bank0_p95, aes(x = y, y = balance)) + 
        geom_boxplot()
g_balance_y_p95
```

Ora comincia a essere evidente che chi sottoscrive depositi tende a avere saldo sul conto più alto; vale per la mediana del gruppo sì, ma anche per il terzo quartile. Quindi per saldi che crescono si tende a sottoscrivere più depositi, il che ha senso. più soldi hai, più ne puoi depositare.

```{r}
bank0 %>%
        filter(balance <=perc_95) %>%
        mutate(balance_class = ntile(balance, 10)) %>%
        group_by (balance_class) %>%
        summarise(n(), mean(y == "yes"))
```

Esatto. al crescere del saldo cresce la quota di coloro che sottoscrivono.

*scrivi meglio perc95 associandolo a balance  echiude bene balance*
